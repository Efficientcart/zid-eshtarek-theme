{# Custom Input Fields Component #}
{# Parameters: product (object with custom_input_fields array) #}
{% if product.custom_input_fields %}
  {# Hidden parent ID for variants #}
  {% if not product.has_variants %}
    <input
      id="product-parent-id"
      type="hidden"
      value="{{ product.id }}"
    />
  {% endif %}

  {% for custom_field in product.custom_input_fields %}
    <div class="custom-field-wrapper">
      {# CHECKBOX Type #}
      {% if custom_field.type == 'CHECKBOX' %}
        <div
          id="product-custom-user-option-fields"
          option-id="product-custom-user-option-fields-group-{{ custom_field.id }}"
          class="grid w-full items-start gap-2"
        >
          {# Hidden field for group ID #}
          <input
            type="hidden"
            class="product-custom-user-option-fields-group"
            name="{{ custom_field.label }}"
            value="{{ custom_field.id }}"
          />

          {# Label #}
          {% with content=custom_field.label, required=custom_field.is_required %}
            {% include 'components/ui/label.jinja' %}
          {% endwith %}

          {# Hint text #}
          {% if custom_field.hint %}
            <p class="text-muted-foreground text-caption">{{ custom_field.hint }}</p>
          {% endif %}

          {# Checkbox options #}
          <div class="space-y-2">
            {% for choice in custom_field.choices %}
              {% set checkbox_label %}
                {{ choice.name }}
                {% if choice.price and choice.price > 0 %}
                  <span class="text-muted-foreground">(+{{ choice.formatted_price }})</span>
                {% endif %}
              {% endset %}
              {%
                with
                id=choice.id,
                name=choice.name,
                label=checkbox_label,
                attrs='data-price-settings="' ~ choice.id ~ '" data-group-id="' ~ custom_field.id ~ '" data-group-name="' ~ custom_field.label ~ '" data-field-type="CHECKBOX" oninput="productOptionInputChanged(event)"'
              %}
                {% include 'components/ui/checkbox.jinja' %}
              {% endwith %}
            {% endfor %}
          </div>
        </div>

        {# DROPDOWN Type #}
      {% elif custom_field.type == 'DROPDOWN' %}
        <div
          id="product-custom-user-dropdown-fields"
          class="grid w-full items-center gap-2"
        >
          {# Build options array #}
          {% set ns = namespace(dropdown_options=[]) %}
          {% for choice in custom_field.choices %}
            {% set option_label = choice.name %}
            {% if choice.price and choice.price > 0 %}
              {% set option_label = choice.name ~ ' (+' ~ choice.formatted_price ~ ')' %}
            {% endif %}
            {%
              set ns.dropdown_options = ns.dropdown_options + [{
                'value': choice.name,
                'label': option_label,
                'attrs': 'data-price-settings="' ~ choice.id ~ '"'
              }]
            %}
          {% endfor %}

          {# Label #}
          {% with for=custom_field.id, content=custom_field.label, required=custom_field.is_required %}
            {% include 'components/ui/label.jinja' %}
          {% endwith %}

          {# Select #}
          {%
            with
            name=custom_field.label,
            id=custom_field.id,
            options=ns.dropdown_options,
            caption=custom_field.hint,
            attrs='data-field-type="DROPDOWN" data-group-id="' ~ custom_field.id ~ '" data-group-name="' ~ custom_field.label ~ '" lang="' ~ session.lang ~ '" onchange="productOptionInputChanged(event)"'
          %}
            {% include 'components/ui/select.jinja' %}
          {% endwith %}
        </div>

        {# FILE / IMAGE Type #}
      {% elif custom_field.type == 'FILE' or custom_field.type == 'IMAGE' %}
        <div
          id="product-custom-user-input-fields"
          class="grid w-full items-center gap-2"
        >
          {# Label with price suffix #}
          {% set label_content = custom_field.label ~ ((' (+' ~ custom_field.formatted_price ~ ')') if custom_field.price and custom_field.price > 0 else '') %}
          {% with for=custom_field.id, content=label_content, required=custom_field.is_required %}
            {% include 'components/ui/label.jinja' %}
          {% endwith %}

          {# File Input #}
          {% if custom_field.type == 'IMAGE' %}
            {% set file_accept = 'image/png, image/jpg, image/jpeg, image/gif' %}
            {% set file_onchange = 'productOptionInputFileChanged(event, "image")' %}
          {% else %}
            {% set file_accept = 'zip, image/png, image/jpg, image/jpeg, image/gif, application/zip, application/x-zip, application/x-zip-compressed, application/x-rar-compressed, application/octet-stream, zz-application/zz-winassoc-psd, application/x-photoshop, application/psd, application/photoshop, application/x-rar, application/vnd.rar, application/vnd.openxmlformats-officedocument.wordprocessingml.document, application/vnd.ms-excel, text/plain, application/msword, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, text/csv, application/csv, application/vnd.ms-powerpoint, application/pdf, application/rtf, application/txt, application/odf' %}
            {% set file_onchange = 'productOptionInputFileChanged(event, "file")' %}
          {% endif %}

          {%
            with
            type='file',
            name=custom_field.label,
            id=custom_field.id,
            caption=custom_field.hint,
            required=custom_field.is_required,
            attrs='data-field-type="' ~ custom_field.type ~ '" data-price-settings="' ~ custom_field.id ~ '" data-group-id="' ~ custom_field.id ~ '" data-group-name="' ~ custom_field.label ~ '" title="' ~ custom_field.label ~ '" lang="' ~ session.lang ~ '" accept="' ~ file_accept ~ '" onchange="' ~ file_onchange ~ '"'
          %}
            {% include 'components/ui/input.jinja' %}
          {% endwith %}
        </div>

        {# TEXTAREA Type #}
      {% elif custom_field.configs and custom_field.configs.is_multiline %}
        <div
          id="product-custom-user-input-fields"
          class="grid w-full items-center gap-2"
        >
          {# Label with price suffix #}
          {% set label_content = custom_field.label ~ ((' (+' ~ custom_field.formatted_price ~ ')') if custom_field.price and custom_field.price > 0 else '') %}
          {% with for=custom_field.id, content=label_content, required=custom_field.is_required %}
            {% include 'components/ui/label.jinja' %}
          {% endwith %}

          {# Textarea #}
          <textarea
            id="{{ custom_field.id }}"
            name="{{ custom_field.label }}"
            data-field-type="TEXTAREA"
            data-price-settings="{{ custom_field.id }}"
            data-group-id="{{ custom_field.id }}"
            data-group-name="{{ custom_field.label }}"
            title="{{ custom_field.label }}"
            lang="{{ session.lang }}"
            placeholder="{{ custom_field.hint }}"
            rows="5"
            {% if custom_field.is_required %}required{% endif %}
            oninput="productOptionInputChanged(event)"
            class="focus:border-foreground border-muted placeholder:text-muted-foreground text-body1 w-full resize-none rounded border px-3 py-3 transition-[border-color,border-width] outline-none hover:border-2 focus:border-2"
          ></textarea>
        </div>

        {# TEXT, NUMBER, DATE, TIME Types #}
      {% else %}
        <div
          id="product-custom-user-input-fields"
          class="grid w-full items-center gap-2"
        >
          {% set input_type = custom_field.type|lower %}
          {% if custom_field.type == 'NUMBER' %}
            {% set input_type = 'text' %}
          {% endif %}

          {% set extra_attrs = 'data-field-type="' ~ custom_field.type ~ '" data-price-settings="' ~ custom_field.id ~ '" data-group-id="' ~ custom_field.id ~ '" data-group-name="' ~ custom_field.label ~ '" title="' ~ custom_field.label ~ '" lang="' ~ session.lang ~ '" oninput="productOptionInputChanged(event)"' %}
          {% if custom_field.type == 'NUMBER' %}
            {% set extra_attrs = extra_attrs ~ ' onkeypress="productOptionInputNumberValidate(event)"' %}
          {% elif custom_field.type == 'DATE' %}
            {% set extra_attrs = extra_attrs ~ ' min="' ~ today() ~ '"' %}
          {% endif %}

          {# Label with price suffix #}
          {% set label_content = custom_field.label ~ ((' (+' ~ custom_field.formatted_price ~ ')') if custom_field.price and custom_field.price > 0 else '') %}
          {% with for=custom_field.id, content=label_content, required=custom_field.is_required %}
            {% include 'components/ui/label.jinja' %}
          {% endwith %}

          {# Input #}
          {%
            with
            type=input_type,
            name=custom_field.label,
            placeholder=custom_field.hint or '',
            required=custom_field.is_required,
            id=custom_field.id,
            attrs=extra_attrs
          %}
            {% include 'components/ui/input.jinja' %}
          {% endwith %}
        </div>
      {% endif %}
    </div>
  {% endfor %}
{% endif %}
