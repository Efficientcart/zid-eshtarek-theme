<section
  section-id="{{ sectionId }}"
  class="px-4 pb-6 md:px-16 md:pb-16"
>
  <div class="theme-container space-y-6">
    <div class="md:flex md:items-center md:justify-between">
      <h2
        class="text-primary text-[32px] leading-[41.6px] [font-variant:all-small-caps] md:text-[40px] md:leading-[48px]"
      >
        {{ settings.title }}
      </h2>
      {% if settings.display_more %}
        <a
          href="{{ settings.products.url or url_for('list_products') }}"
          class="text-primary hidden items-center gap-2 px-4 py-3 text-[16px] leading-[24px] md:flex"
        >
          {{ settings.more_text }}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            class="rtl:rotate-180"
          >
            <path
              d="M16.8917 12.8019H4.70224C4.45758 12.8019 4.25449 12.7211 4.09299 12.5594C3.93133 12.3977 3.85049 12.1946 3.85049 11.9501C3.85049 11.7056 3.93133 11.5026 4.09299 11.3409C4.25449 11.1792 4.45758 11.0984 4.70224 11.0984H16.8917L13.3592 7.55989C13.1892 7.39389 13.1084 7.19597 13.1167 6.96614C13.1251 6.73631 13.2142 6.53639 13.3842 6.36639C13.5502 6.20056 13.7472 6.11864 13.975 6.12064C14.2028 6.12247 14.4017 6.20639 14.5717 6.37239L19.5527 11.3474C19.6441 11.4387 19.7104 11.5341 19.7517 11.6334C19.7929 11.7326 19.8135 11.8381 19.8135 11.9501C19.8135 12.0621 19.7929 12.1677 19.7517 12.2669C19.7104 12.3662 19.6441 12.4616 19.5527 12.5529L14.5967 17.5029C14.4267 17.6689 14.2278 17.7528 14 17.7546C13.7722 17.7566 13.5752 17.6727 13.4092 17.5029C13.2392 17.3369 13.1542 17.1348 13.1542 16.8966C13.1542 16.6585 13.2392 16.4544 13.4092 16.2844L16.8917 12.8019Z"
              fill="currentColor"
            ></path>
          </svg>
        </a>
      {% endif %}
    </div>
    <div class="embla">
      <div class="embla__viewport overflow-hidden">
        <div class="embla__container">
          {% for product in settings.products.results %}
            <div class="embla__slide">
              <div
                class="group relative flex flex-col gap-4"
                {% if product.is_infinite == false and product.quantity <= 0 %}
                  data-out-of-stock
                {% endif %}
              >
                <div class="relative aspect-[3/4] w-full overflow-hidden rounded">
                  <img
                    {% if product.images or product.videos %}
                      src="{{ product.main_image.image.small if product.main_image else '' }}"
                    {% else %}
                      src="{{ image_url(('images/product-img.svg' | asset_url), w=235, q=100, f='auto') }}"
                    {% endif %}
                    alt="{{ product.name }}"
                    class="h-full w-full object-cover object-center"
                    {% if loop.index0 > 0 %}loading="lazy"{% endif %}
                  />

                  <div class="absolute start-4 top-4 flex flex-col gap-2">
                    <span
                      class="bg-foreground hidden w-fit rounded px-2 py-1 text-[16px] leading-normal [font-variant:all-small-caps] group-data-[out-of-stock]:block"
                    >
                      OUT OF STOCK
                    </span>
                    <span
                      class="bg-background w-fit rounded px-2 text-[16px] leading-normal [font-variant:all-small-caps]"
                    >
                      NEW
                    </span>
                    <span
                      class="bg-background w-fit rounded px-2 text-[16px] leading-normal [font-variant:all-small-caps]"
                    >
                      SELLING FAST
                    </span>
                  </div>
                  {% if store.settings.products.wishlist_enabled %}
                    <button class="bg-background/10 absolute right-4 bottom-4 rounded p-2 backdrop-blur-xs">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="24"
                        height="24"
                        viewBox="0 0 24 24"
                        class="text-primary"
                        fill="none"
                      >
                        <path
                          d="M12.335 4.90039C14.4876 2.96816 17.8154 3.03282 19.8887 5.11035C21.9615 7.18744 22.0335 10.494 20.1104 12.6533L12 20.7773L3.88867 12.6533C1.96591 10.4938 2.04034 7.18232 4.11133 5.11133C6.18662 3.03604 9.50781 2.96534 11.667 4.90039L12.001 5.2002L12.335 4.90039ZM19.1807 5.81738C17.4935 4.12681 14.7711 4.05738 13.0029 5.64453L12.001 6.54297L11 5.64551C9.22716 4.05645 6.50963 4.12709 4.81836 5.81836C3.14268 7.49404 3.05766 10.1774 4.60254 11.9512L4.61426 11.9648L4.62598 11.9766L11.6465 19.0078L12 19.3623L12.3535 19.0078L19.374 11.9766L19.3857 11.9648L19.3975 11.9512C20.9431 10.1765 20.8577 7.4981 19.1807 5.81738Z"
                          fill="#0B0A09"
                          stroke="#0B0A09"
                        ></path>
                      </svg>
                    </button>
                  {% endif %}
                </div>
                <div>
                  <h3 class="text-[20px] leading-[28px] [font-variant:all-small-caps]">{{ product.name }}</h3>
                  {% if store.settings.products.reviews_enabled %}
                    {% if product.rating %}
                      <div class="flex items-center gap-2">
                        {% set rating = product.rating.average %}
                        {% include 'components/rating-stars.jinja' %}
                        {% if product.rating.total_count > 0 %}
                          <span class="text-secondary text-[14px] leading-[1.5]"
                            >({{ product.rating.total_count }})</span
                          >
                        {% endif %}
                      </div>
                    {% endif %}
                  {% endif %}
                  <div class="flex flex-wrap items-center gap-2">
                    <p class="text-primary text-[16px] leading-[24px]">{{ product.formatted_price }}</p>
                    {% if product.formatted_sale_price is not none %}
                      <span class="text-destructive text-[14px] leading-[21px] line-through">
                        {{ product.formatted_sale_price }}
                      </span>
                    {% endif %}
                    <span
                      class="inline-flex items-center rounded-md bg-[#DDF8DC] px-2 py-1 text-base leading-normal [line-height:normal] text-[#649560] [font-variant:all-small-caps]"
                    >
                      {{ _("Discount") }} {{ product.discount_percentage }}%
                    </span>
                  </div>
                </div>
                {% if product.is_infinite == false and product.quantity <= 0 %}
                  <button
                    disabled
                    class="border-primary text-primary w-full cursor-not-allowed rounded border px-4 py-3 opacity-50"
                  >
                    Add to bag
                  </button>
                {% else %}
                  <button class="border-primary text-primary w-full rounded border px-4 py-3">Select option</button>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <div class="embla__progress h-1 w-full rounded-full bg-[#F6F5F4]">
        <div
          class="embla__progress-bar h-1 rounded-full bg-[#A89C90]"
          style="width: 0%"
        ></div>
      </div>
      <div class="hidden items-center gap-2 md:flex">
        <button
          class="embla__prev p-2.5"
          aria-label="Previous"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            class="rtl:rotate-180"
            fill="none"
          >
            <path
              d="M10.2945 11.9752L14.6477 16.3284C14.8177 16.4984 14.8986 16.6974 14.8902 16.9252C14.8819 17.153 14.7927 17.3519 14.6227 17.5219C14.4527 17.6919 14.2496 17.7769 14.0135 17.7769C13.7773 17.7769 13.5742 17.6919 13.4042 17.5219L8.46022 12.5779C8.36889 12.4866 8.30255 12.3913 8.26122 12.2919C8.21989 12.1928 8.19922 12.0872 8.19922 11.9752C8.19922 11.8632 8.21989 11.7576 8.26122 11.6584C8.30255 11.5591 8.36889 11.4638 8.46022 11.3724L13.4292 6.40344C13.5992 6.23344 13.8023 6.14844 14.0385 6.14844C14.2746 6.14844 14.4777 6.23344 14.6477 6.40344C14.8177 6.57344 14.9027 6.77652 14.9027 7.01269C14.9027 7.24885 14.8177 7.45194 14.6477 7.62194L10.2945 11.9752Z"
              fill="currentColor"
            ></path>
          </svg>
        </button>

        <button
          class="embla__next p-2.5"
          aria-label="Next"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            class="rtl:rotate-180"
            fill="none"
          >
            <path
              d="M13.1081 11.9746L8.7548 7.62135C8.5848 7.45135 8.50397 7.25244 8.5123 7.0246C8.52064 6.79677 8.6098 6.59785 8.7798 6.42785C8.9498 6.25785 9.15289 6.17285 9.38905 6.17285C9.62522 6.17285 9.8283 6.25785 9.9983 6.42785L14.9423 11.3719C15.0336 11.4632 15.1 11.5585 15.1413 11.6579C15.1826 11.757 15.2033 11.8626 15.2033 11.9746C15.2033 12.0866 15.1826 12.1922 15.1413 12.2914C15.1 12.3907 15.0336 12.486 14.9423 12.5774L9.9733 17.5464C9.8033 17.7164 9.60439 17.7972 9.37655 17.7889C9.14872 17.7805 8.9498 17.6914 8.7798 17.5214C8.6098 17.3514 8.5248 17.1483 8.5248 16.9121C8.5248 16.6759 8.6098 16.4729 8.7798 16.3029L13.1081 11.9746Z"
              fill="currentColor"
            ></path>
          </svg>
        </button>
      </div>
      {% if settings.display_more %}
        <a
          href="{{ settings.products.url or url_for('list_products') }}"
          class="text-primary flex items-center gap-2 px-4 py-3 text-[16px] leading-[24px] whitespace-nowrap md:hidden"
        >
          {{ settings.more_text }}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            class="rtl:rotate-180"
          >
            <path
              d="M16.8917 12.8019H4.70224C4.45758 12.8019 4.25449 12.7211 4.09299 12.5594C3.93133 12.3977 3.85049 12.1946 3.85049 11.9501C3.85049 11.7056 3.93133 11.5026 4.09299 11.3409C4.25449 11.1792 4.45758 11.0984 4.70224 11.0984H16.8917L13.3592 7.55989C13.1892 7.39389 13.1084 7.19597 13.1167 6.96614C13.1251 6.73631 13.2142 6.53639 13.3842 6.36639C13.5502 6.20056 13.7472 6.11864 13.975 6.12064C14.2028 6.12247 14.4017 6.20639 14.5717 6.37239L19.5527 11.3474C19.6441 11.4387 19.7104 11.5341 19.7517 11.6334C19.7929 11.7326 19.8135 11.8381 19.8135 11.9501C19.8135 12.0621 19.7929 12.1677 19.7517 12.2669C19.7104 12.3662 19.6441 12.4616 19.5527 12.5529L14.5967 17.5029C14.4267 17.6689 14.2278 17.7528 14 17.7546C13.7722 17.7566 13.5752 17.6727 13.4092 17.5029C13.2392 17.3369 13.1542 17.1348 13.1542 16.8966C13.1542 16.6585 13.2392 16.4544 13.4092 16.2844L16.8917 12.8019Z"
              fill="currentColor"
            ></path>
          </svg>
        </a>
      {% endif %}
    </div>
  </div>
</section>

<style>
  [section-id="{{ sectionId }}"] .embla {
    --slide-spacing: 1rem; /* 16px gap from design */
    --slide-size: 320px; /* Mobile card width */
  }

  [section-id="{{ sectionId }}"] .embla__container {
    display: flex;
    touch-action: pan-y pinch-zoom;
    margin-inline-start: calc(var(--slide-spacing) * -1);
  }

  [section-id="{{ sectionId }}"] .embla__slide {
    transform: translate3d(0, 0, 0);
    flex: 0 0 var(--slide-size);
    min-width: 0;
    padding-inline-start: var(--slide-spacing);
  }

  @media (min-width: 1024px) {
    [section-id="{{ sectionId }}"] .embla {
      --slide-size: 380px; /* Desktop card width */
    }
  }
</style>

<script>
  (function () {
    const section = document.querySelector('[section-id="{{ sectionId }}"]');
    if (!section) return;

    const emblaRoot = section.querySelector(".embla");
    const viewport = emblaRoot.querySelector(".embla__viewport");
    const container = emblaRoot.querySelector(".embla__container");
    const prevBtn = section.querySelector(".embla__prev");
    const nextBtn = section.querySelector(".embla__next");
    const progressBar = section.querySelector(".embla__progress-bar");

    if (!container || container.children.length <= 1) return;

    const embla = EmblaCarousel(viewport, {
      direction: document.dir === "rtl" ? "rtl" : "ltr",
      loop: false,
      align: "start",
      slidesToScroll: 1,
      skipSnaps: false,
      containScroll: "trimSnaps",
      breakpoints: {
        "(min-width: 1024px)": {
          slidesToScroll: 2
        }
      }
    });

    if (prevBtn) prevBtn.onclick = () => embla.scrollPrev();
    if (nextBtn) nextBtn.onclick = () => embla.scrollNext();

    const clamp = (n, min, max) => Math.max(min, Math.min(n, max));
    const updateProgress = () => {
      const p = clamp(embla.scrollProgress(), 0, 1);
      if (progressBar) progressBar.style.width = `${p * 100}%`;
      if (prevBtn) prevBtn.disabled = !embla.canScrollPrev();
      if (nextBtn) nextBtn.disabled = !embla.canScrollNext();
    };

    embla.on("init", updateProgress);
    embla.on("scroll", updateProgress);
    embla.on("reInit", updateProgress);
  })();
</script>
